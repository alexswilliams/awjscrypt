<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>QuickTest Test</title>
    <style>
      div#results {
        border: 1px solid black;
        padding: 1em;
        margin: 1em;
        font-family: sans-serif;
      }

      div.result {
        padding: 1em;
        margin: 0.5em;
      }

      div.details {
        font-family: monospace;
        margin-left: 2em;
      }

      div.pass {
        background-color: #dfd;
        border: 1px solid #393;
      }

      div.fail {
        background-color: #fdd;
        border: 1px solid #933;
      }
    </style>
  </head>
  <body>
    <h1>QuickTest Test</h1>
    <button id="runTest">Run Tests</button>
    <div id="results">

    </div>
    <script src="quicktest.js"></script>
    <script>
      document.getElementById('runTest').addEventListener('click', function() {
        const tests = [
          {
            desc: 'Test result matching expected result should pass',
            testFunction: function() { return 12; },
            expectedResult: 12,
          },
          {
            desc: 'Test result not matching expected result should fail',
            testFunction: function() { return 'orange'; },
            expectedResult: 12
          },
          {
            desc: 'Error being thrown when no throwable expected should fail',
            testFunction: function() {throw new Error('some error');},
            expectedResult: 12
          },
          {
            desc: 'Wrong error type being thrown (a different error is expected) should fail',
            testFunction: function() {throw new RangeError('some range error');},
            expectedError: TypeError
          },
          {
            desc: 'Expected error type being thrown should pass',
            testFunction: function() { throw new TypeError('some type error'); },
            expectedError: TypeError
          },
          {
            desc: 'Expected error type being thrown, ' +
                  'and observed message beginning with expected message, should pass',
            testFunction: function() {
              throw new TypeError('some type error longer than expected');
            },
            expectedError: new TypeError('some type error')
          },
          {
            desc: 'Expected error type being thrown, ' +
                  'but observed message does not start with expected message, should fail',
            testFunction: function() { throw new TypeError('some type error'); },
            expectedError: new TypeError('rogue message')
          },
          {
            desc: 'Wrong error type being thrown, but has an expected message prefix, should fail',
            testFunction: function() {
              throw new TypeError('some type error longer than expected');
            },
            expectedError: new RangeError('some type error')
          }
        ];

        let outDiv = document.getElementById('results');

        /** @type {Generator} */
        let testIteration = QuickTestIterator(tests);
        let done = false;
        let i = 0;
        do {
          i++;
          let testResultObject = testIteration.next();
          if (testResultObject.done) {
            break;
          }

          /** @type {TestResult} */
          let result = testResultObject.value;

          let resultDiv = document.createElement('div');
          resultDiv.id = 'result-' + i;
          resultDiv.classList.add('result');
          resultDiv.classList.add(result.testPassed ? 'pass' : 'fail');
          let resultString = document.createTextNode(
              'Test ' + (result.testPassed ? 'Passed' : 'Failed')
              + ' - ' + result.testDescription
              + ' (' + result.testDurationInMilliseconds.toPrecision(3) + 'ms)');
          resultDiv.appendChild(resultString);

          if (!result.testPassed) {
            let detailsHeaderDiv = document.createElement('div');
            detailsHeaderDiv.id = 'details-header-' + i;
            detailsHeaderDiv.classList.add('details-header');
            detailsHeaderDiv.appendChild(
                document.createTextNode('Details: ' + result.testDiagnosis));
            resultDiv.appendChild(detailsHeaderDiv);

            let detailsDiv = document.createElement('div');
            detailsDiv.id = 'details-' + i;
            detailsDiv.classList.add('details');
            detailsDiv.innerHTML =
                '<pre>' +
                'Expected Result: type = ' + (typeof result.expectedResult) +
                '; value = ' + result.expectedResult +
                '\n' +
                'Observed Result: type = ' + (typeof result.observedResult) +
                '; value = ' + result.observedResult +
                '\n' +
                'Expected Error: type = ' + (typeof result.expectedError) +
                '; value = ' + result.expectedError +
                '\n' +
                'Observed Error: type = ' + (typeof result.thrownError) +
                '; value = ' + result.thrownError;
            if (typeof result.thrownError === 'object') {
              detailsDiv.innerHTML +=
                  '<pre>\nStack Trace:\n' + result.thrownError.stack;
            }
            resultDiv.appendChild(detailsDiv);
          }

          outDiv.appendChild(resultDiv);
          console.log(testResultObject);
        } while (!done);

      });
    </script>
  </body>
</html>